
<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अनिक फायनान्शियल सर्व्हिसेस - अंतिम विश्लेषण</title>
    
    <!-- CSS Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #0056b3;
            --primary-light: #e6f0ff;
            --positive-color: #28a745;
            --positive-light: #e9f7ec;
            --negative-color: #dc3545;
            --negative-light: #fdecea;
            --neutral-color: #ffc107;
            --neutral-light: #fff9e6;
            --info-color: #17a2b8;
            --info-light: #e7f6f8;
            --white-bg: #ffffff;
            --light-bg: #f4f6f9;
            --text-color: #333;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Noto Sans Devanagari', sans-serif; 
            background-color: var(--light-bg); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            background: var(--white-bg); 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: var(--shadow-md); 
        }
        .main-header { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        h1.main-title { 
            color: #004085; 
            margin: 0; 
            font-size: 1.8em; 
            font-weight: 700; 
        }
        .upload-section { text-align: center; padding: 25px; border: 2px dashed #007bff; border-radius: 8px; margin-bottom: 25px; background-color: #f8f9fa; }
        .upload-section p { font-weight: 500; }
        input[type="file"], input[type="password"] { display: block; width: calc(100% - 24px); max-width: 400px; margin: 12px auto; padding: 12px; border-radius: 6px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: background-color 0.3s; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        #printButton { background-color: var(--positive-color); display: block; margin: 30px auto 0; }
        .hidden { display: none; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { display: flex; align-items: center; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; border: 1px solid transparent; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .kpi-card.theme-primary { background: linear-gradient(135deg, var(--primary-light), var(--white-bg)); border-color: var(--primary-light); }
        .kpi-card.theme-positive { background: linear-gradient(135deg, var(--positive-light), var(--white-bg)); border-color: var(--positive-light); }
        .kpi-card.theme-negative { background: linear-gradient(135deg, var(--negative-light), var(--white-bg)); border-color: var(--negative-light); }
        .kpi-icon { font-size: 2.5em; margin-right: 18px; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; flex-shrink: 0; }
        .kpi-icon svg { width: 100%; height: 100%; }
        .theme-primary .kpi-icon, .theme-primary .kpi-value { color: var(--primary-color); }
        .theme-positive .kpi-icon, .theme-positive .kpi-value { color: var(--positive-color); }
        .theme-negative .kpi-icon, .theme-negative .kpi-value { color: var(--negative-color); }
        .kpi-content { flex: 1; }
        .kpi-title { font-size: 0.95em; font-weight: 500; color: var(--text-muted); margin: 0 0 5px 0; }
        .kpi-value { font-size: 1.8em; font-weight: 700; margin: 0; }
        
        #report-content h3 { color: #004085; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; margin-top: 30px; font-weight: 700; font-size: 1.4em; }
        .report-main-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-top: 20px; }
        .section-box { background-color: #fdfdfd; padding: 25px; border: 1px solid var(--border-color); border-radius: 12px; }
        .section-title { font-size: 1.2em; font-weight: 700; color: #004085; margin: 0 0 20px 0; text-align: center; }

        .financial-summary-container { display: flex; align-items: center; gap: 25px; background-color: #f8f9fa; padding: 25px; border-radius: 15px; }
        .donut-chart-wrapper { position: relative; width: 150px; height: 150px; flex-shrink: 0; }
        .donut-chart-svg { transform: rotate(-90deg); }
        .donut-chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .donut-chart-center .center-label { margin: 0; font-size: 0.9em; color: var(--text-muted); font-weight: 500; }
        .donut-chart-center .center-value { margin: 2px 0 0 0; font-size: 1.6em; color: var(--primary-color); font-weight: bold; }
        .financial-legend { flex: 1; }
        .legend-item { display: flex; align-items: center; margin-bottom: 12px; }
        .legend-color-box { height: 15px; width: 15px; border-radius: 50%; margin-right: 10px; }
        .legend-item .legend-label { margin: 0; font-size: 0.9em; color: var(--text-muted); }
        .legend-item .legend-value { margin: 0; font-size: 1.2em; font-weight: 700; }

        #recommendation-box { padding: 20px; margin-top: 15px; border-radius: 8px; font-size: 1.2em; text-align: center; font-weight: 700; border-left: 5px solid; }
        .recommendation-positive { background-color: var(--positive-light); color: #155724; border-color: var(--positive-color); }
        .recommendation-negative { background-color: var(--negative-light); color: #721c24; border-color: var(--negative-color); }
        .recommendation-neutral { background-color: var(--neutral-light); color: #856404; border-color: var(--neutral-color); }
        .recommendation-info { background-color: var(--info-light); color: #0c5460; border-color: var(--info-color); }
        
        .recommended-amount-box { padding: 15px; margin-top: 15px; border-radius: 8px; background-color: var(--primary-light); text-align: center; border-left: 5px solid var(--primary-color); }
        .recommended-amount-box p { margin: 0; color: var(--primary-color); }
        .recommended-amount-box .amount-label { font-weight: 500; font-size: 1em; }
        .recommended-amount-box .amount-value { font-weight: 700; font-size: 1.4em; margin-top: 5px; }

        #exposure-summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #exposure-summary-table th, #exposure-summary-table td { padding: 10px; border: 1px solid var(--border-color); text-align: left; }
        #exposure-summary-table thead th { background-color: #e9ecef; color: #495057; font-weight: 700; }
        
        #decision-points { list-style: none; padding-left: 0; margin-top: 15px; }
        #decision-points li { padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: flex-start; background-color: #f8f9fa; }
        #decision-points li::before { font-family: 'Arial'; font-weight: bold; margin-right: 15px; font-size: 1.5em; line-height: 1; }
        #decision-points li.negative::before { content: '❌'; }
        #decision-points li.positive::before { content: '✅'; }
        #decision-points li.neutral::before { content: 'ℹ️'; }
        
        .report-footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; text-align: center; font-size: 0.9em; color: var(--text-muted); }
        #loader { text-align: center; padding: 30px; }
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            @page { size: A4; margin: 0.4in; }
            body { font-size: 9.5pt; background: #fff; }
            .container { width: 100%; max-width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            .upload-section, #printButton, #loader { display: none; }
            .main-header { display: flex !important; border-bottom: 1px solid #ccc; margin-bottom: 15px; padding-bottom: 10px;}
            h1.main-title { font-size: 14pt; }
            #report-container { display: block !important; }
            #report-content { border: none; padding: 0; }
            .report-footer { display: block !important; position: fixed; bottom: 20px; left: 0.4in; right: 0.4in; text-align: center; border-top: 1px solid #ccc; padding-top: 8px; font-size: 8pt; color: #666; }
            .kpi-grid, .report-main-layout { grid-template-columns: 1fr 1fr; gap: 15px; }
            .financial-summary-container { padding: 15px; }
            .kpi-card, .section-box, #decision-points li { padding: 12px; box-shadow: none; background: none; border: 1px solid var(--border-color); break-inside: avoid; }
            .kpi-value { font-size: 1.5em; }
            .kpi-title { font-size: 0.9em; }
            h3, .section-title { font-size: 11pt; margin-bottom: 10px; padding-bottom: 5px; }
            #recommendation-box, .recommended-amount-box { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-header">
            <h1 class="main-title"> अनिक फायनान्शियल सर्व्हिसेस - अंतिम विश्लेषण</h1>
        </div>
        <div class="upload-section">
            <p>ग्राहकाचा इक्वीफॅक्स रिर्पाट अपलोड करा नंतर फायनल रिर्पाट प्रिंट करून कर्ज मागणी गृपला शेअर करा.</p>
            <input type="file" id="pdfFile" accept=".pdf">
            <input type="password" id="pdfPassword" placeholder="PDF पासवर्ड टाका (आवश्यक)">
            <button onclick="analyzeFile()">विश्लेषण करा</button>
        </div>
        <div id="loader" class="hidden"><p>कृपया थांबा... अचूक माहितीसाठी रिपोर्ट तपासत आहे...</p><div class="spinner"></div></div>
        
        <div id="report-container" class="hidden">
            <div id="report-content">
                <h3 style="text-align:center; border:none; margin-bottom: 10px;">ग्राहक पत विश्लेषण रिपोर्ट: <span id="headerCustomerName" style="color:var(--primary-color);"></span></h3>
                
                <!-- NEW: This div will show the queried name if the record is not found -->
                <div id="queriedCustomerNameContainer" class="hidden" style="text-align: center; margin-bottom: 20px; font-size: 1.1em; color: var(--text-muted);">
                    <p id="queriedCustomerName"></p>
                </div>
                
                <div class="kpi-grid">
                    <div id="kpi-card-score" class="kpi-card theme-primary"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M13 12V8h-2v4H7l5 6 5-6h-4z"></path></svg></div><div class="kpi-content"><p class="kpi-title">क्रेडिट स्कोअर</p><p id="kpi-score" class="kpi-value"></p></div></div>
                    <div class="kpi-card theme-primary"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-3V4c0-1.103-.897-2-2-2H9c-1.103 0-2 .897-2 2v2H4c-1.103 0-2 .897-2 2v11c0 1.103.897 2 2 2h16c1.103 0 2-.897 2-2V8c0-1.103-.897-2-2-2zM9 4h6v2H9V4zm11 15H4V8h16v11z"></path><path d="M12 10c-1.654 0-3 1.346-3 3s1.346 3 3 3 3-1.346 3-3-1.346-3-3-3zm0 4c-.551 0-1-.449-1-1s.449-1 1-1 1 .449 1 1-.449 1-1 1z"></path></svg></div><div class="kpi-content"><p class="kpi-title">एकूण कर्ज शिल्लक</p><p id="kpi-total-balance" class="kpi-value"></p></div></div>
                    <div class="kpi-card theme-positive"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 17.615V21h-2v-3.385A9.943 9.943 0 0 1 3.385 13H0v-2h3.385A9.943 9.943 0 0 1 11 3.385V0h2v3.385A9.943 9.943 0 0 1 20.615 11H24v2h-3.385A9.943 9.943 0 0 1 13 17.615zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path></svg></div><div class="kpi-content"><p class="kpi-title">एकूण मासिक हप्ता (EMI)</p><p id="kpi-monthly-emi" class="kpi-value"></p></div></div>
                    <div class="kpi-card theme-negative"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.486,2,2,6.486,2,12s4.486,10,10,10,10-4.486,10-10S17.514,2,12,2Zm3.707,12.293-1.414,1.414L12,13.414,9.707,15.707,8.293,14.293,10.586,12,8.293,9.707,9.707,8.293,12,10.586l2.293-2.293,1.414,1.414L13.414,12Z"></path></svg></div><div class="kpi-content"><p class="kpi-title">चालू कर्ज (एकूण)</p><p id="kpi-open-accounts" class="kpi-value"></p></div></div>
                    <div class="kpi-card theme-negative"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M11 7h2v7h-2zm0 8h2v2h-2z"></path></svg></div><div class="kpi-content"><p class="kpi-title">थकीत खाती (Past Due)</p><p id="kpi-past-due" class="kpi-value"></p></div></div>
                    <div class="kpi-card theme-negative"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15 2H9C7.346 2 6 3.346 6 5v14c0 1.654 1.346 3 3 3h6c1.654 0 3-1.346 3-3V5c0-1.654-1.346-2-3-2zm-3 18c-.827 0-1.5-.673-1.5-1.5S11.173 17 12 17s1.5.673 1.5 1.5S12.827 20 12 20zm3-4H9V5h6v11z"></path></svg></div><div class="kpi-content"><p class="kpi-title">राइट-ऑफ रक्कम</p><p id="kpi-written-off" class="kpi-value"></p></div></div>
                </div>

                <div class="report-main-layout">
                    <div class="left-column">
                        <div class="section-box">
                            <h4 class="section-title">कर्ज मंजुरीसाठी शिफारस</h4>
                            <div id="recommendation-box"><p id="recommendation"></p></div>
                            <div id="recommended-amount-container" class="recommended-amount-box hidden">
                                <p class="amount-label">शिफारस केलेली कर्जाची रक्कम</p>
                                <p class="amount-value" id="recommended-amount"></p>
                            </div>
                        </div>
                        <div class="section-box" style="margin-top:25px;">
                            <h4 class="section-title">शिफारशीचे आधारभूत मुद्दे (RBI नियमांनुसार)</h4>
                            <ul id="decision-points"></ul>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="section-box">
                            <h4 class="section-title">आर्थिक सारांश (Financial Summary)</h4>
                            <div class="financial-summary-container">
                                <div class="donut-chart-wrapper"><svg width="150" height="150" viewBox="0 0 36 36" class="donut-chart-svg"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e6e6e6" stroke-width="3.5" /><path id="chart-arc-balance" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--primary-color)" stroke-width="3.5" stroke-dasharray="0, 100" /><path id="chart-arc-overdue" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--neutral-color)" stroke-width="3.5" stroke-dasharray="0, 100" /><path id="chart-arc-writtenoff" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--negative-color)" stroke-width="3.5" stroke-dasharray="0, 100" /></svg><div class="donut-chart-center"><p class="center-label">एकूण कर्ज</p><p class="center-value" id="chart-total-debt">₹ 0</p></div></div>
                                <div class="financial-legend"><div class="legend-item"><span class="legend-color-box" style="background-color: var(--primary-color);"></span><div><p class="legend-label">एकूण शिल्लक</p><p class="legend-value" id="legend-balance">₹ 0</p></div></div><div class="legend-item"><span class="legend-color-box" style="background-color: var(--neutral-color);"></span><div><p class="legend-label">थकीत रक्कम</p><p class="legend-value" id="legend-overdue">₹ 0</p></div></div><div class="legend-item"><span class="legend-color-box" style="background-color: var(--negative-color);"></span><div><p class="legend-label">राईट-ऑफ</p><p class="legend-value" id="legend-writtenoff">₹ 0</p></div></div></div>
                            </div>
                        </div>
                        <div class="section-box" style="margin-top:25px;">
                             <h4 class="section-title">कर्ज एक्सपोजर सारांश (Loan Exposure)</h4>
                             <table id="exposure-summary-table">
                                <thead><tr><th>कंपनीचे नाव</th><th>शिल्लक रक्कम</th></tr></thead>
                                <tbody id="exposure-tbody"></tbody>
                             </table>
                        </div>
                    </div>
                </div>

                <div class="report-footer">
                    <p><strong>टीप:</strong> वरील विश्लेषण हे रिपोर्टमधील माहितीवर आधारित असून केवळ सूचक आहे. अंतिम निर्णय घेण्यापूर्वी मूळ रिपोर्ट आणि ग्राहकाची कागदपत्रे तपासणे बंधनकारक आहे.</p>
                    <p>हा रिपोर्ट <span id="reportDate"></span> रोजी तयार करण्यात आला.</p>
                </div>
            </div>
            <button id="printButton" onclick="printReport()">रिपोर्ट प्रिंट/सेव्ह करा</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;

        async function analyzeFile() {
            const fileInput = document.getElementById('pdfFile');
            if (fileInput.files.length === 0) { alert('कृपया एक PDF फाईल निवडा.'); return; }
            const password = document.getElementById('pdfPassword').value;
            if (!password) {
                alert('ही इक्विफॅक्स सर्व्हरची फाईल नाही. कृपया पासवर्ड असलेली खरी इक्विफॅक्स फाईल वापरा.');
                return;
            }
            
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('report-container').classList.add('hidden');
            const file = fileInput.files[0];
            try {
                const arrayBuffer = await file.arrayBuffer();
                const typedarray = new Uint8Array(arrayBuffer);
                const pdf = await pdfjsLib.getDocument({ data: typedarray, password }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ');
                }
                const analysisResult = analyzeCreditReportText(fullText);
                displayReport(analysisResult);
            } catch (error) {
                console.error("PDF processing error:", error);
                alert('PDF वाचण्यात अडचण येत आहे. पासवर्ड चुकीचा असू शकतो किंवा फाईल खराब असू शकते.');
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        function calculateAge(dobString, reportDateString) { try { const [dobDay, dobMonth, dobYear] = dobString.split('-').map(Number); const [repDay, repMonth, repYear] = reportDateString.split('-').map(Number); const dob = new Date(dobYear, dobMonth - 1, dobDay); const reportDate = new Date(repYear, repMonth - 1, repDay); let age = reportDate.getFullYear() - dob.getFullYear(); const m = reportDate.getMonth() - dob.getMonth(); if (m < 0 || (m === 0 && reportDate.getDate() < dob.getDate())) { age--; } return age; } catch (e) { return 0; } }
        
        function analyzeCreditReportText(text) {
            // UPDATED: Create a base result object
            const result = { 
                name: "माहिती आढळली नाही", score: "N/A", age: 0, openAccounts: 0, 
                pastDueAccounts: 0, totalBalance: 0, overdueAmount: 0, monthlyInstallment: 0, 
                writtenOffAmount: 0, otherCompanyOpenAccounts: 0, pastDueCompanies: [], 
                negativeAccounts: [], activeLoanDetails: [],
                recordNotFound: false, // Flag for "not found" case
                queriedName: "" // To store the name that was searched for
            };

            // UPDATED: Handle "Consumer record not found" case
            if (text.includes('Consumer record not found')) {
                result.recordNotFound = true;
                result.name = "माहिती आढळली नाही";

                // Try to find the name that was queried
                let nameMatch = text.match(/Consumer’s Full Name\s*:\s*([A-Za-z\s]+)/i) || text.match(/Consumer’s First Name\s*:\s*([A-Za-z\s]+)/i);
                if (nameMatch && nameMatch[1]) {
                    result.queriedName = nameMatch[1].trim();
                }
                return result; // Return immediately
            }

            // Original logic for when a record is found
            let cleanText = text; const legendMarker = "Glossary, Terms and Explanations:"; const markerIndex = text.indexOf(legendMarker); if (markerIndex !== -1) { cleanText = text.substring(0, markerIndex); }
            
            const dobMatch = cleanText.match(/DOB:\s*(\d{2}-\d{2}-\d{4})/i); const reportDateMatch = cleanText.match(/DATE:\s*(\d{2}-\d{2}-\d{4})/i); if (dobMatch && reportDateMatch) { result.age = calculateAge(dobMatch[1], reportDateMatch[1]); }
            const normalizedText = cleanText.toLowerCase().replace(/\s+/g, ' ');
            if (normalizedText.includes('credit report summary')) { result.pastDueAccounts = parseInt(normalizedText.match(/number of past due accounts\s*:\s*(\d+)/)?.[1] || '0', 10); result.totalBalance = parseFloat(normalizedText.match(/total balance amount\s*:\s*(?:rs\.\s*)?([\d,.]+)/)?.[1].replace(/,/g, '') || '0'); result.overdueAmount = parseFloat(normalizedText.match(/total past due amount\s*:\s*(?:rs\.\s*)?([\d,.]+)/)?.[1].replace(/,/g, '') || '0'); result.monthlyInstallment = parseFloat(normalizedText.match(/total monthly instmt amt\s*:\s*(?:rs\.\s*)?([\d,.]+)/)?.[1].replace(/,/g, '') || '0'); result.writtenOffAmount = parseFloat(normalizedText.match(/total written off amount\s*:\s*(?:rs\.\s*)?([\d,.]+)/)?.[1].replace(/,/g, '') || '0'); }
            const nameRegex = /Consumer Name:\s*([A-Z\s]+?)(?=Personal Information|Identification|Family Details|Consumer Address|DOB:)/i; 
            const nameMatch = cleanText.match(nameRegex);
            if (nameMatch && nameMatch[1]) { result.name = nameMatch[1].trim(); }
            result.score = (cleanText.match(/(?:cibil|equifax|experian)\s*score\s*:?\s*(\d{3})/) || ["", "N/A"])[1];
            const accountChunks = cleanText.split(/Institution\s*:/);
            if (accountChunks.length > 1) {
                let openAccountsCounter = 0;
                for (let i = 1; i < accountChunks.length; i++) {
                    const chunk = accountChunks[i]; const institutionNameMatch = chunk.match(/^\s*([\w\s.&]+?)(?=Loan Category|Past Due Amount|Current Balance)/i); let companyName = ""; if (institutionNameMatch && institutionNameMatch[1]) { companyName = institutionNameMatch[1].replace(/Pvt\s*Ltd|Private\s*Limited|Limited|Services|Finance|Finance Bank/ig, '').trim(); }
                    const statusLineMatch = chunk.match(/Status\s*:(.*?)(?=Disbursed Amount|Last Payment Date)/i); const statusLine = statusLineMatch ? statusLineMatch[1].toLowerCase() : '';
                    if (statusLine.includes('current') || statusLine.includes('past due')) {
                        openAccountsCounter++;
                        if (!/anik/i.test(companyName)) { result.otherCompanyOpenAccounts++; }
                        const currentBalanceMatch = chunk.match(/Current Balance\s*:\s*(?:Rs\.\s*)?([\d,.]+)/i);
                        const currentBalance = currentBalanceMatch ? parseFloat(currentBalanceMatch[1].replace(/,/g, '')) : 0;
                        if (companyName) result.activeLoanDetails.push({ company: companyName, balance: currentBalance });
                    }
                    const historyLineMatch = chunk.match(/History 24 Months\s*:(.*?)(?=Name:|$)/i); const historyLine = historyLineMatch ? historyLineMatch[1].toLowerCase() : '';
                    if (statusLine.includes('past due')) { if (companyName && !result.pastDueCompanies.includes(companyName)) { result.pastDueCompanies.push(companyName); } }
                    let reason = null; if (statusLine.includes('written off')) { reason = 'राईट-ऑफ'; } else if (statusLine.includes('settled')) { reason = 'सेटल'; } else if (historyLine.includes('sub')) { reason = 'सब-स्टँडर्ड'; } else if (historyLine.includes('wdf') || historyLine.includes('dbf')) { reason = 'डाउटफुल'; }
                    if (reason && companyName && !result.negativeAccounts.some(acc => acc.company === companyName)) { result.negativeAccounts.push({ company: companyName, reason: reason }); }
                }
                result.openAccounts = openAccountsCounter;
            }
            return result;
        }

        function generateDecision(analysis) {
            const points = []; let recommendationText = "", recommendationClass = "", recommendedLoanAmount = "निर्णय प्रलंबित";

            // UPDATED: Handle "record not found" case first
            if (analysis.recordNotFound) {
                recommendationText = "रेकॉर्ड उपलब्ध नाही";
                recommendationClass = "recommendation-info"; // A new neutral/info class
                recommendedLoanAmount = "मॅन्युअल तपासणी आवश्यक";
                points.push({ text: `इक्विफॅक्समध्ये या ग्राहकाचा कोणताही क्रेडिट रेकॉर्ड आढळला नाही. हा एक नवीन ग्राहक असू शकतो .`, type: "neutral" });
                return { recommendation: recommendationText, class: recommendationClass, points: points, recommendedLoanAmount: recommendedLoanAmount };
            }

            // Original decision logic
            if (analysis.age > 60) { recommendationText = "हाय रिस्क (High Risk)"; recommendationClass = "recommendation-negative"; recommendedLoanAmount = "शिफारस नाही"; points.push({ text: `ग्राहकाचे वय ${analysis.age} वर्षे आहे, जे 60 वर्षांपेक्षा जास्त आहे. कर्ज मंजुरीचा निर्णय मॅनेजरांनी काळजीपूर्वक घ्यावा.`, type: "negative" }); } 
            else if (analysis.negativeAccounts.length > 0 || analysis.writtenOffAmount > 0 || analysis.pastDueAccounts > 0) {
                recommendationText = "हाय रिस्क (High Risk)"; recommendationClass = "recommendation-negative"; recommendedLoanAmount = "शिफारस नाही";
                let reasonsGenerated = false;
                analysis.negativeAccounts.forEach(acc => { points.push({ text: `<strong>${acc.company}</strong> या कंपनीचे कर्ज '<strong>${acc.reason}</strong>' आहे.`, type: "negative" }); reasonsGenerated = true; });
                if (analysis.pastDueCompanies.length > 0) { points.push({ text: `<strong>${analysis.pastDueCompanies.join(', ')}</strong> या कंपनीचे कर्ज 'पास्ट ड्यू' (थकीत) आहे.`, type: "negative" }); reasonsGenerated = true; }
                if (!reasonsGenerated && analysis.writtenOffAmount > 0) { points.push({ text: `रिपोर्टमध्ये <strong>₹ ${new Intl.NumberFormat('en-IN').format(analysis.writtenOffAmount)}</strong> इतकी 'राईट-ऑफ' रक्कम आढळली आहे.`, type: "negative" }); }
                if (!reasonsGenerated && analysis.pastDueAccounts > 0 && analysis.pastDueCompanies.length === 0) { points.push({ text: `रिपोर्टमध्ये <strong>${analysis.pastDueAccounts}</strong> 'पास्ट ड्यू' (थकीत) खाती आढळली आहेत.`, type: "negative" }); }
                points.push({ text: `त्यामुळे, कर्ज मंजुरीचा निर्णय मॅनेजरांनी सर्व बाबी तपासून काळजीपूर्वक घ्यावा.`, type: "neutral" });
            } 
            else if (analysis.totalBalance > 120000) { recommendationText = "हाय रिस्क (High Risk)"; recommendationClass = "recommendation-negative"; recommendedLoanAmount = "शिफारस नाही"; points.push({ text: `एकूण बाकी रक्कम ₹ ${new Intl.NumberFormat('en-IN').format(analysis.totalBalance)} आहे (120000 पेक्षा जास्त).`, type: "negative" }); } 
            else if (analysis.otherCompanyOpenAccounts >= 3) { recommendationText = "हाय रिस्क (High Risk)"; recommendationClass = "recommendation-negative"; recommendedLoanAmount = "शिफारस नाही"; points.push({ text: `अनिक वगळून, ग्राहकाचे कर्ज ${analysis.otherCompanyOpenAccounts} इतर कंपन्यांमध्ये चालू आहे, ज्यामुळे कर्जाचा बोजा जास्त आहे.`, type: "negative" }); } 
            else if (analysis.totalBalance < 50000 && analysis.openAccounts > 0) { recommendationText = "मध्यम रिस्क (Medium Risk)"; recommendationClass = "recommendation-neutral"; recommendedLoanAmount = "₹ 25,000 पर्यंत विचार करावा"; points.push({ text: `एकूण थकबाकी ₹ ${new Intl.NumberFormat('en-IN').format(analysis.totalBalance)} (पन्नास हजारांपेक्षा कमी) आहे, ही एक सकारात्मक बाब आहे.`, type: "positive" }); points.push({ text: `तरीही, चालू कर्जे असल्याने, परतफेड क्षमता तपासून मर्यादित कर्ज देण्याचा विचार करता येईल.`, type: "neutral" }); } 
            else if (analysis.otherCompanyOpenAccounts === 2) { recommendationText = "मध्यम रिस्क (Medium Risk)"; recommendationClass = "recommendation-neutral"; recommendedLoanAmount = "₹ 25,000 पर्यंत मर्यादित"; points.push({ text: `अनिक वगळून, ग्राहकाचे कर्ज २ इतर कंपन्यांमध्ये चालू आहे. परतफेड क्षमतेचे मूल्यांकन करणे आवश्यक आहे.`, type: "neutral" }); points.push({ text: `कर्ज मंजुरी फक्त ₹ 25,000 पर्यंत मर्यादित ठेवण्याची शिफारस आहे.`, type: "neutral" }); } 
            else { recommendationText = "लो रिस्क (Low Risk)"; recommendationClass = "recommendation-positive"; recommendedLoanAmount = "₹ 50,000 पर्यंत (क्षमतेनुसार)"; points.push({ text: "रिपोर्ट पूर्णपणे स्वच्छ आहे आणि इतर कंपन्यांमध्ये कमी कर्ज आहेत.", type: "positive" }); points.push({ text: "कर्ज मंजुरी युनिटच्या अंतिम निर्णयावर अवलंबून असेल.", type: "positive" }); }
            return { recommendation: recommendationText, class: recommendationClass, points: points, recommendedLoanAmount: recommendedLoanAmount };
        }

        function renderDonutChart(analysis) { const formatCurrency = (num) => `₹ ${new Intl.NumberFormat('en-IN', {maximumFractionDigits: 0}).format(num)}`; const { totalBalance, overdueAmount, writtenOffAmount } = analysis; const totalDebt = totalBalance + overdueAmount + writtenOffAmount; document.getElementById('chart-total-debt').textContent = formatCurrency(totalDebt); document.getElementById('legend-balance').textContent = formatCurrency(totalBalance); document.getElementById('legend-overdue').textContent = formatCurrency(overdueAmount); document.getElementById('legend-writtenoff').textContent = formatCurrency(writtenOffAmount); if (totalDebt === 0) { ['balance', 'overdue', 'writtenoff'].forEach(id => document.getElementById(`chart-arc-${id}`).setAttribute('stroke-dasharray', '0, 100')); return; } const balancePercent = (totalBalance / totalDebt) * 100; const overduePercent = (overdueAmount / totalDebt) * 100; const writtenOffPercent = (writtenOffAmount / totalDebt) * 100; let overdueOffset = balancePercent; let writtenOffOffset = balancePercent + overdueOffset; document.getElementById('chart-arc-balance').setAttribute('stroke-dasharray', `${balancePercent}, 100`); document.getElementById('chart-arc-balance').setAttribute('style', `stroke-dashoffset: 0`); document.getElementById('chart-arc-overdue').setAttribute('stroke-dasharray', `${overduePercent}, 100`); document.getElementById('chart-arc-overdue').setAttribute('style', `stroke-dashoffset: ${-overdueOffset}`); document.getElementById('chart-arc-writtenoff').setAttribute('stroke-dasharray', `${writtenOffPercent}, 100`); document.getElementById('chart-arc-writtenoff').setAttribute('style', `stroke-dashoffset: ${-writtenOffOffset}`); }
        
        function displayReport(analysis) {
            const formatCurrency = (num) => `₹ ${new Intl.NumberFormat('en-IN', {maximumFractionDigits: 0}).format(num)}`;
            
            // UPDATED: Handle the display for "record not found"
            const queriedNameContainer = document.getElementById('queriedCustomerNameContainer');
            if (analysis.recordNotFound) {
                document.getElementById('headerCustomerName').textContent = analysis.name.toUpperCase();
                if(analysis.queriedName){
                    document.getElementById('queriedCustomerName').innerHTML = `<strong>नाव:</strong> ${analysis.queriedName.toUpperCase()}`;
                    queriedNameContainer.classList.remove('hidden');
                }
            } else {
                document.getElementById('headerCustomerName').textContent = analysis.name.toUpperCase();
                queriedNameContainer.classList.add('hidden'); // Hide it for normal reports
            }

            // Original display logic
            const scoreCard = document.getElementById('kpi-card-score');
            if (analysis.score === 'N/A' || analysis.score === "" ) { scoreCard.style.display = 'none'; } else { scoreCard.style.display = 'flex'; document.getElementById('kpi-score').textContent = analysis.score; }
            document.getElementById('kpi-open-accounts').textContent = `${analysis.openAccounts}`;
            document.getElementById('kpi-total-balance').textContent = formatCurrency(analysis.totalBalance);
            document.getElementById('kpi-monthly-emi').textContent = formatCurrency(analysis.monthlyInstallment);
            document.getElementById('kpi-past-due').textContent = analysis.pastDueAccounts;
            document.getElementById('kpi-written-off').textContent = formatCurrency(analysis.writtenOffAmount);
            
            const decision = generateDecision(analysis);
            const recommendationBox = document.getElementById('recommendation-box');
            recommendationBox.className = ''; recommendationBox.classList.add(decision.class);
            document.getElementById('recommendation').textContent = decision.recommendation;
            
            const recommendedAmountContainer = document.getElementById('recommended-amount-container');
            if(decision.recommendedLoanAmount === "शिफारस नाही" || decision.recommendedLoanAmount === "निर्णय प्रलंबित") {
                recommendedAmountContainer.classList.add('hidden');
            } else {
                document.getElementById('recommended-amount').textContent = decision.recommendedLoanAmount;
                recommendedAmountContainer.classList.remove('hidden');
            }
            
            const pointsList = document.getElementById('decision-points');
            pointsList.innerHTML = '';
            decision.points.forEach(point => { const li = document.createElement('li'); li.innerHTML = point.text; li.classList.add(point.type); pointsList.appendChild(li); });
            
            const exposureTbody = document.getElementById('exposure-tbody');
            exposureTbody.innerHTML = '';
            if (analysis.activeLoanDetails.length > 0) {
                analysis.activeLoanDetails.forEach(loan => {
                    const row = exposureTbody.insertRow();
                    row.insertCell(0).textContent = loan.company;
                    row.insertCell(1).textContent = formatCurrency(loan.balance);
                });
            } else {
                const row = exposureTbody.insertRow();
                const cell = row.insertCell(0);
                cell.textContent = "सध्या एकही कर्ज चालू नाही.";
                cell.colSpan = 2;
                cell.style.textAlign = 'center';
            }
            
            document.getElementById('reportDate').textContent = new Date().toLocaleString('mr-IN', { dateStyle: 'short', timeStyle: 'medium' });
            document.getElementById('report-container').classList.remove('hidden');
            renderDonutChart(analysis); 
        }
        function printReport() { window.print(); }
    </script>
</body>
</html>